name: Weekly Security Audit

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm_audit
        continue-on-error: true
        run: |
          npm audit --json > npm-audit.json 2>&1 || true
          echo "NPM_AUDIT_EXIT=$?" >> $GITHUB_ENV

      - name: Parse npm audit results
        id: parse_npm
        run: |
          if [ -f npm-audit.json ]; then
            CRITICAL=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
          fi

      - name: Upload npm audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit.json

  pip-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run pip-audit
        id: pip_audit
        continue-on-error: true
        run: |
          pip-audit --format json --output pip-audit.json || true

      - name: Upload pip audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit.json

  create-issue:
    needs: [npm-audit, pip-audit]
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: read
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download npm audit
        uses: actions/download-artifact@v4
        with:
          name: npm-audit-report
          path: ./reports
        continue-on-error: true

      - name: Download pip audit
        uses: actions/download-artifact@v4
        with:
          name: pip-audit-report
          path: ./reports
        continue-on-error: true

      - name: Check for critical vulnerabilities
        id: check_vulns
        run: |
          python3 - <<'PY'
import json
import os
from pathlib import Path

reports_dir = Path('./reports')
npm_critical = 0
pip_critical = 0

npm_report = reports_dir / 'npm-audit.json'
if npm_report.exists():
    npm_data = json.loads(npm_report.read_text(encoding='utf-8'))
    npm_critical = int(npm_data.get('metadata', {}).get('vulnerabilities', {}).get('critical', 0) or 0)

pip_report = reports_dir / 'pip-audit.json'
if pip_report.exists():
    pip_data = json.loads(pip_report.read_text(encoding='utf-8'))
    if isinstance(pip_data, list):
        pip_critical = sum(1 for finding in pip_data if str(finding.get('severity', '')).lower() == 'critical')

total_critical = npm_critical + pip_critical
output_file = os.environ['GITHUB_OUTPUT']
with open(output_file, 'a', encoding='utf-8') as fh:
    fh.write(f'npm_critical={npm_critical}\n')
    fh.write(f'pip_critical={pip_critical}\n')
    fh.write(f'total_critical={total_critical}\n')
PY

      - name: Create issue if critical vulnerabilities found
        if: fromJSON(steps.check_vulns.outputs.total_critical) > 0
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Alert: Critical vulnerabilities found (${date})`,
              body: `## Weekly Security Audit\n\nCritical vulnerabilities were detected in dependencies.\n\nPlease review the audit artifacts and update affected packages.\n\n**Action Required:** Run \`npm audit fix\` and \`pip-audit --fix\`\n\n---\n*Automated by weekly-security-audit workflow*`,
              labels: ['security', 'critical', 'automated']
            });
