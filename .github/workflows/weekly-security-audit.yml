name: Weekly Security Audit

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm_audit
        continue-on-error: true
        run: |
          npm audit --json > npm-audit.json 2>&1 || true
          echo "NPM_AUDIT_EXIT=$?" >> $GITHUB_ENV

      - name: Parse npm audit results
        id: parse_npm
        run: |
          if [ -f npm-audit.json ]; then
            CRITICAL=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
          fi

      - name: Upload npm audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit.json

  pip-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run pip-audit
        id: pip_audit
        continue-on-error: true
        run: |
          pip-audit --format json --output pip-audit.json || true

      - name: Upload pip audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit.json

  create-issue:
    needs: [npm-audit, pip-audit]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download npm audit
        uses: actions/download-artifact@v4
        with:
          name: npm-audit-report
          path: ./reports
        continue-on-error: true

      - name: Download pip audit
        uses: actions/download-artifact@v4
        with:
          name: pip-audit-report
          path: ./reports
        continue-on-error: true

      - name: Check for critical vulnerabilities
        id: check_vulns
        run: |
          CRITICAL=0
          if [ -f ./reports/npm-audit.json ]; then
            NPM_CRITICAL=$(cat ./reports/npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')
            CRITICAL=$((CRITICAL + NPM_CRITICAL))
          fi
          echo "total_critical=$CRITICAL" >> $GITHUB_OUTPUT

      - name: Create issue if critical vulnerabilities found
        if: steps.check_vulns.outputs.total_critical > 0
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Alert: Critical vulnerabilities found (${date})`,
              body: `## Weekly Security Audit\n\nCritical vulnerabilities were detected in dependencies.\n\nPlease review the audit artifacts and update affected packages.\n\n**Action Required:** Run \`npm audit fix\` and \`pip-audit --fix\`\n\n---\n*Automated by weekly-security-audit workflow*`,
              labels: ['security', 'critical', 'automated']
            });
