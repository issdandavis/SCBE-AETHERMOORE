name: Coherence Gate

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Coherence score threshold (0.0 - 1.0)'
        required: false
        default: '0.20'
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  coherence-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          npm ci
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping Python deps"
          fi

      - name: Determine threshold
        id: config
        run: |
          THRESHOLD="${{ github.event.inputs.threshold || '0.20' }}"
          echo "threshold=$THRESHOLD" >> "$GITHUB_OUTPUT"

      - name: Run Layer 11 coherence check
        id: coherence
        continue-on-error: true
        run: |
          if [ ! -f scripts/coherence-check.py ]; then
            echo "coherence-check.py not found, generating fallback report"
            echo '{"coherence": 0.0, "status": "skip", "reason": "Script not found"}' > coherence-report.json
            exit 0
          fi
          python scripts/coherence-check.py \
            --threshold ${{ steps.config.outputs.threshold }} \
            --json-path coherence-report.json

      - name: Extract coherence score
        id: extract
        if: always()
        run: |
          if [ ! -f coherence-report.json ]; then
            echo '{"coherence": 0.0, "status": "error", "reason": "No report generated"}' > coherence-report.json
          fi
          python3 - <<'PY'
          import json, os
          from pathlib import Path
          data = json.loads(Path('coherence-report.json').read_text())
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"coherence={data.get('coherence', 0.0)}\n")
              fh.write(f"status={data.get('status', 'error')}\n")
              fh.write(f"reason={data.get('reason', '')}\n")
          PY

      - name: Upload coherence report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coherence-report
          path: coherence-report.json
          retention-days: 30

      - name: Comment coherence report on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coherence = '${{ steps.extract.outputs.coherence }}';
            const status = '${{ steps.extract.outputs.status }}';
            const reason = '${{ steps.extract.outputs.reason }}';
            const threshold = '${{ steps.config.outputs.threshold }}';
            const icon = status === 'pass' ? '\u2705' : status === 'skip' ? '\u26a0\ufe0f' : '\u274c';
            const lines = [
              '## Layer 11 Coherence Gate',
              '',
              `| Metric | Value |`,
              `|--------|-------|`,
              `| Score | **${coherence}** |`,
              `| Status | ${icon} **${status}** |`,
              `| Threshold | **${threshold}** |`,
            ];
            if (reason) lines.push(`| Note | ${reason} |`);
            lines.push('', '---', '*SCBE-AETHERMOORE Governance Layer*');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: lines.join('\n'),
            });

      - name: Write job summary
        if: always()
        run: |
          echo "## Layer 11 Coherence Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Score | **${{ steps.extract.outputs.coherence }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | **${{ steps.extract.outputs.status }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | **${{ steps.config.outputs.threshold }}** |" >> $GITHUB_STEP_SUMMARY

      - name: Enforce coherence threshold
        if: always() && steps.extract.outputs.status != 'pass' && steps.extract.outputs.status != 'skip'
        run: |
          echo "::error::Coherence gate failed: score ${{ steps.extract.outputs.coherence }} below threshold ${{ steps.config.outputs.threshold }}"
          exit 1
