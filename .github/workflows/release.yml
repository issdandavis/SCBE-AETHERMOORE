name: Release CLI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF_NAME}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Validate source directory
        run: |
          if [ ! -d packages/sixtongues ]; then
            echo "::error::packages/sixtongues directory not found"
            echo "Available directories:"
            ls -la packages/ 2>/dev/null || echo "No packages/ directory"
            exit 1
          fi

      - name: Create CLI archive
        run: |
          zip -r sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip packages/sixtongues/ \
            -x "*.pyc" -x "**/__pycache__/*"
          echo "Created: sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip"
          ls -la sixtongues-cli-*.zip

      - name: Upload to Dropbox
        continue-on-error: true
        env:
          DROPBOX_TOKEN: ${{ secrets.DROPBOX_TOKEN }}
        run: |
          if [ -z "$DROPBOX_TOKEN" ]; then
            echo "::notice::DROPBOX_TOKEN not configured, skipping upload"
            exit 0
          fi
          ZIP_FILE="sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip"
          DROPBOX_PATH="/AetherVideo/products/cli/${ZIP_FILE}"
          curl -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer ${DROPBOX_TOKEN}" \
            --header "Dropbox-API-Arg: {\"path\": \"${DROPBOX_PATH}\", \"mode\": \"overwrite\"}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @"${ZIP_FILE}"
          echo "Uploaded to Dropbox: ${DROPBOX_PATH}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Six Tongues Secure Tokenizer ${{ steps.version.outputs.VERSION }}
          body: |
            ## Six Tongues Secure Tokenizer ${{ steps.version.outputs.VERSION }}

            Quantum-resistant tokenization CLI for AI-secured workflows.
            Part of the SCBE-Aethermoore governance system.

            ### Installation
            ```bash
            unzip sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip
            cd sixtongues
            pip install -r requirements.txt
            python sixtongues.py --help
            ```

            ---
            *Revenue funds ongoing SCBE-AETHERMOORE research and the Entropic Defense Engine.*
          files: |
            sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false

      - name: Summary
        if: always()
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | **${{ steps.version.outputs.VERSION }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Archive | sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | Created |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.DROPBOX_TOKEN }}" ]; then
            echo "| Dropbox | Uploaded to /AetherVideo/products/cli/ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dropbox | Skipped (no token) |" >> $GITHUB_STEP_SUMMARY
          fi
