name: Release CLI

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Create CLI archive
        run: |
          zip -r sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip packages/sixtongues/ \
              -x "*.pyc" -x "**/__pycache__/*"
          echo "Created: sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip"
          ls -la sixtongues-cli-*.zip

      - name: Upload to Dropbox
              if: secrets.DROPBOX_TOKEN
        env:
          DROPBOX_TOKEN: ${{ secrets.DROPBOX_TOKEN }}
        run: |
          ZIP_FILE="sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip"
          DROPBOX_PATH="/AetherVideo/products/cli/${ZIP_FILE}"

          # Upload using Dropbox API
          curl -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer ${DROPBOX_TOKEN}" \
            --header "Dropbox-API-Arg: {\"path\": \"${DROPBOX_PATH}\", \"mode\": \"overwrite\"}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @"${ZIP_FILE}"

          echo "Uploaded to Dropbox: ${DROPBOX_PATH}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Six Tongues Secure Tokenizer ${{ steps.version.outputs.VERSION }}
          body: |
            ## Six Tongues Secure Tokenizer ${{ steps.version.outputs.VERSION }}

            Quantum-resistant tokenization CLI for AI-secured workflows.

            ### Features
            - Phonetically-engineered Six Sacred Tongues (KO, AV, RU, CA, UM, DR)
            - AES-256-GCM encryption with post-quantum Kyber/Dilithium scaffolding
            - Cross-tongue translation with attestation (`xlate`)
            - Stripe-mode blending for multi-domain data (`blend`/`unblend`)
            - GeoSeal encrypt/decrypt for location-bound tokens
            - Interactive REPL mode

            ### Installation
            ```bash
            unzip sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip
            cd sixtongues
            pip install -r requirements.txt
            python sixtongues.py --help
            ```

            ### Quick Start
            ```bash
            # Encode text with Avar tongue
            python sixtongues.py encode --tongue av --text "Hello World"

            # Interactive mode
            python sixtongues.py interactive
            ```

            ---
            *Revenue funds ongoing SCBE-AETHERMOORE research and the Entropic Defense Engine.*
          files: |
            sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive:** sixtongues-cli-${{ steps.version.outputs.VERSION }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release:** Created" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.DROPBOX_TOKEN }}" ]; then
            echo "- **Dropbox:** Uploaded to /AetherVideo/products/cli/" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Dropbox:** Skipped (no token configured)" >> $GITHUB_STEP_SUMMARY
          fi
