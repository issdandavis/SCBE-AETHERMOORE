name: Daily Review

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  daily-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run JavaScript tests
        id: npm_test
        continue-on-error: true
        run: npm test

      - name: Run Python tests
        id: pytest
        continue-on-error: true
        run: pytest tests/ -v

      - name: Run lint
        id: lint
        continue-on-error: true
        run: npm run lint

      - name: Run type check
        id: typecheck
        continue-on-error: true
        run: npm run typecheck

      - name: Run coherence check
        id: coherence
        if: always()
        continue-on-error: true
        run: |
          npm_outcome='${{ steps.npm_test.outcome }}'
          pytest_outcome='${{ steps.pytest.outcome }}'
          lint_outcome='${{ steps.lint.outcome }}'
          type_outcome='${{ steps.typecheck.outcome }}'

          if [ "$npm_outcome" = "success" ] && [ "$pytest_outcome" = "success" ]; then test_score=1; else test_score=0; fi
          if [ "$lint_outcome" = "success" ]; then lint_score=1; else lint_score=0; fi
          if [ "$type_outcome" = "success" ]; then type_score=1; else type_score=0; fi

          python scripts/coherence-check.py \
            --threshold 0.97 \
            --test-pass-rate "$test_score" \
            --lint-score "$lint_score" \
            --type-coverage "$type_score" \
            --json-path coherence-report.json

      - name: Export coherence outputs
        id: coherence_summary
        if: always()
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path('coherence-report.json').read_text())
          with open(Path(__import__('os').environ['GITHUB_OUTPUT']), 'a', encoding='utf-8') as fh:
              fh.write(f"coherence={data['coherence']}\n")
              fh.write(f"coherence_status={data['status']}\n")
          PY

      - name: Build review summary
        id: summary
        if: always()
        run: |
          npm_result='${{ steps.npm_test.outcome }}'
          pytest_result='${{ steps.pytest.outcome }}'
          lint_result='${{ steps.lint.outcome }}'
          typecheck_result='${{ steps.typecheck.outcome }}'
          coherence_status='${{ steps.coherence_summary.outputs.coherence_status }}'

          echo "npm_result=$npm_result" >> "$GITHUB_OUTPUT"
          echo "pytest_result=$pytest_result" >> "$GITHUB_OUTPUT"
          echo "lint_result=$lint_result" >> "$GITHUB_OUTPUT"
          echo "typecheck_result=$typecheck_result" >> "$GITHUB_OUTPUT"
          echo "coherence_status=$coherence_status" >> "$GITHUB_OUTPUT"

          if [ "$npm_result" != "success" ] || [ "$pytest_result" != "success" ] || [ "$coherence_status" != "pass" ]; then
            echo "tests_failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "tests_failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue for failures
        if: always() && steps.summary.outputs.tests_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Daily Review Failure - ${new Date().toISOString().slice(0, 10)}`;
            const body = [
              '## Daily Review Summary',
              '',
              `- npm test: **${{ steps.summary.outputs.npm_result }}**`,
              `- pytest tests/ -v: **${{ steps.summary.outputs.pytest_result }}**`,
              `- npm run lint: **${{ steps.summary.outputs.lint_result }}**`,
              `- npm run typecheck: **${{ steps.summary.outputs.typecheck_result }}**`,
              `- Layer 11 coherence score: **${{ steps.coherence_summary.outputs.coherence }}** (${{ steps.coherence_summary.outputs.coherence_status }})`,
              '',
              'This issue was created automatically by the Daily Review workflow.'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['daily-review', 'automated']
            });

      - name: Fail job if tests failed
        if: always() && steps.summary.outputs.tests_failed == 'true'
        run: |
          echo "Daily review detected failing tests or low coherence."
          exit 1
