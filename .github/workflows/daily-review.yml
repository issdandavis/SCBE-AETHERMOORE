name: Daily Review

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  daily-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run JavaScript tests
        id: npm_test
        continue-on-error: true
        run: npm test

      - name: Run Python tests
        id: pytest
        continue-on-error: true
        run: pytest tests/ -v

      - name: Run lint
        id: lint
        continue-on-error: true
        run: npm run lint

      - name: Run type check
        id: typecheck
        continue-on-error: true
        run: npm run typecheck

      - name: Build review summary
        id: summary
        if: always()
        run: |
          npm_result='${{ steps.npm_test.outcome }}'
          pytest_result='${{ steps.pytest.outcome }}'
          lint_result='${{ steps.lint.outcome }}'
          typecheck_result='${{ steps.typecheck.outcome }}'

          echo "npm_result=$npm_result" >> "$GITHUB_OUTPUT"
          echo "pytest_result=$pytest_result" >> "$GITHUB_OUTPUT"
          echo "lint_result=$lint_result" >> "$GITHUB_OUTPUT"
          echo "typecheck_result=$typecheck_result" >> "$GITHUB_OUTPUT"

          if [ "$npm_result" != "success" ] || [ "$pytest_result" != "success" ]; then
            echo "tests_failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "tests_failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue for failures
        if: always() && steps.summary.outputs.tests_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Daily Review Failure - ${new Date().toISOString().slice(0, 10)}`;
            const body = [
              '## Daily Review Summary',
              '',
              `- npm test: **${{ steps.summary.outputs.npm_result }}**`,
              `- pytest tests/ -v: **${{ steps.summary.outputs.pytest_result }}**`,
              `- npm run lint: **${{ steps.summary.outputs.lint_result }}**`,
              `- npm run typecheck: **${{ steps.summary.outputs.typecheck_result }}**`,
              '',
              'This issue was created automatically by the Daily Review workflow.'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['daily-review', 'automated']
            });

      - name: Fail job if tests failed
        if: always() && steps.summary.outputs.tests_failed == 'true'
        run: |
          echo "Daily review detected failing tests."
          exit 1
