{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "scbe://schemas/decision_envelope_v1.schema.json",
  "title": "SCBE Decision Envelope v1 (JSON Projection)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "projection_of",
    "envelope_id",
    "issued_at_utc",
    "identity",
    "authority",
    "scope",
    "constraints",
    "boundary",
    "quorum",
    "harmonic_wall",
    "audit"
  ],
  "properties": {
    "@context": {
      "oneOf": [
        { "type": "string" },
        { "type": "array", "items": { "type": "string" } },
        { "type": "object" }
      ]
    },
    "@type": { "type": "string", "const": "SCBEDecisionEnvelopeV1" },
    "schema_version": { "type": "string", "const": "decision-envelope/v1" },
    "projection_of": {
      "type": "string",
      "const": "scbe.decision_envelope.v1.DecisionEnvelopeV1"
    },
    "envelope_id": { "type": "string", "minLength": 8 },
    "issued_at_utc": { "type": "string", "format": "date-time" },
    "identity": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mission_id", "swarm_id"],
      "properties": {
        "mission_id": { "type": "string", "minLength": 1 },
        "swarm_id": { "type": "string", "minLength": 1 }
      }
    },
    "authority": {
      "type": "object",
      "additionalProperties": false,
      "required": ["issuer", "key_id", "valid_from_utc", "valid_until_utc", "signature"],
      "properties": {
        "issuer": { "type": "string", "minLength": 1 },
        "key_id": { "type": "string", "minLength": 1 },
        "valid_from_utc": { "type": "string", "format": "date-time" },
        "valid_until_utc": { "type": "string", "format": "date-time" },
        "signature": {
          "type": "object",
          "additionalProperties": false,
          "required": ["algorithm", "value_b64", "signed_protobuf_sha256"],
          "properties": {
            "algorithm": { "type": "string", "minLength": 1 },
            "value_b64": { "type": "string", "minLength": 16 },
            "signed_protobuf_sha256": {
              "type": "string",
              "pattern": "^[A-Fa-f0-9]{64}$"
            }
          }
        }
      }
    },
    "scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["agent_allowlist", "capability_allowlist", "target_allowlist"],
      "properties": {
        "agent_allowlist": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true,
          "minItems": 1
        },
        "capability_allowlist": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true,
          "minItems": 1
        },
        "target_allowlist": {
          "type": "array",
          "minItems": 1,
          "uniqueItems": true,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["kind", "id"],
            "properties": {
              "kind": { "type": "string", "minLength": 1 },
              "id": { "type": "string", "minLength": 1 }
            }
          }
        }
      }
    },
    "constraints": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mission_phase_allowlist",
        "resource_floors",
        "max_risk_tier",
        "harmonic_wall"
      ],
      "properties": {
        "mission_phase_allowlist": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true,
          "minItems": 1
        },
        "resource_floors": {
          "type": "object",
          "additionalProperties": false,
          "required": ["power_mw_min", "bandwidth_kbps_min", "thermal_headroom_c_min"],
          "properties": {
            "power_mw_min": { "type": "number", "minimum": 0 },
            "bandwidth_kbps_min": { "type": "number", "minimum": 0 },
            "thermal_headroom_c_min": { "type": "number" }
          }
        },
        "max_risk_tier": {
          "type": "string",
          "enum": ["REFLEX", "DELIBERATION", "CRITICAL"]
        },
        "harmonic_wall": {
          "type": "object",
          "additionalProperties": false,
          "required": ["scarcity_limit", "base", "alpha"],
          "properties": {
            "scarcity_limit": { "type": "number", "minimum": 0 },
            "base": { "type": "number", "exclusiveMinimum": 1 },
            "alpha": { "type": "number", "exclusiveMinimum": 0 }
          }
        }
      }
    },
    "boundary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["behavior", "reason"],
      "properties": {
        "behavior": {
          "type": "string",
          "enum": ["AUTO_ALLOW", "QUARANTINE", "DENY"]
        },
        "reason": { "type": "string", "minLength": 1 },
        "recovery": {
          "type": "object",
          "additionalProperties": false,
          "required": ["playbook_id", "required_steps", "escalation_target"],
          "properties": {
            "playbook_id": { "type": "string", "minLength": 1 },
            "required_steps": {
              "type": "array",
              "minItems": 1,
              "items": { "type": "string", "minLength": 1 }
            },
            "escalation_target": { "type": "string", "minLength": 1 },
            "retry_after_utc": { "type": "string", "format": "date-time" }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "behavior": {
                "enum": ["QUARANTINE", "DENY"]
              }
            }
          },
          "then": { "required": ["recovery"] }
        }
      ]
    },
    "quorum": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "n",
        "f_max",
        "quorum_min",
        "quorum_policy",
        "approvals_observed",
        "approver_ids",
        "vote_set_sha256"
      ],
      "properties": {
        "n": { "type": "integer", "minimum": 1 },
        "f_max": { "type": "integer", "minimum": 0 },
        "quorum_min": { "type": "integer", "minimum": 1 },
        "quorum_policy": { "type": "integer", "minimum": 1 },
        "approvals_observed": { "type": "integer", "minimum": 0 },
        "approver_ids": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true
        },
        "vote_set_sha256": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{64}$"
        }
      }
    },
    "harmonic_wall": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "d_star",
        "coherence",
        "scarcity_score",
        "harmonic_cost",
        "threshold",
        "inside_boundary"
      ],
      "properties": {
        "d_star": { "type": "number" },
        "coherence": { "type": "number" },
        "scarcity_score": { "type": "number", "minimum": 0 },
        "harmonic_cost": { "type": "number", "minimum": 0 },
        "threshold": { "type": "number", "minimum": 0 },
        "inside_boundary": { "type": "boolean" }
      }
    },
    "audit": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "canonicalization",
        "signed_protobuf_sha256",
        "mmr_leaf_sha256",
        "mmr_prev_root_sha256",
        "mmr_leaf_index",
        "hash_fields"
      ],
      "properties": {
        "canonicalization": {
          "type": "string",
          "const": "PROTOBUF_DETERMINISTIC_V1"
        },
        "signed_protobuf_sha256": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{64}$"
        },
        "mmr_leaf_sha256": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{64}$"
        },
        "mmr_prev_root_sha256": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{64}$"
        },
        "mmr_leaf_index": { "type": "integer", "minimum": 0 },
        "hash_fields": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        }
      }
    }
  }
}

